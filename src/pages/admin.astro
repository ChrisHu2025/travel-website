---
// src/pages/admin.astro
import { cmsConfig } from '../lib/cms/config';

export const prerender = true;

// åºåˆ—åŒ–é…ç½®ä¸ºå†…è” JSON
const serializedConfig = JSON.stringify({
  ...cmsConfig,
  load_config_file: false
});
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å†…å®¹ç®¡ç†ç³»ç»Ÿ - Explore China</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/decap-cms@3.9.0/dist/cms.css" />
  <style>
    body { margin: 0; background: #f5f5f5; font-family: -apple-system, sans-serif; }
    .cms-loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: white; z-index: 9999;
    }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { color: #666; font-size: 16px; }
  </style>
</head>
<body>
  <div id="nc-root" is:inline></div>

  <!-- âœ… 1. æ³¨å…¥é…ç½® -->
  <script id="cms-config" type="application/json" is:inline set:html={serializedConfig}></script>

  <!-- âœ… 2. Loading ç•Œé¢ -->
  <div class="cms-loading" id="js-loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">æ­£åœ¨åˆå§‹åŒ–å†…å®¹ç®¡ç†ç³»ç»Ÿ...</div>
  </div>

  <!-- âœ… 3. æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨æ•è· Token å¹¶å¼ºåˆ¶ç™»å½• -->
  <script is:inline>
    window.CMS_MANUAL_INIT = true;

    window.addEventListener('message', (event) => {
      // æ£€æŸ¥æ˜¯å¦æ˜¯ GitHub è®¤è¯æ¶ˆæ¯
      if (typeof event.data === 'string' && event.data.startsWith('authorization:github:success:')) {
        console.log('âš¡ï¸ [Force Login] æ•è·åˆ° Tokenï¼Œå‡†å¤‡å¼ºåˆ¶å†™å…¥å­˜å‚¨...');

        try {
          const jsonStr = event.data.match(/success:(.+)/)[1];
          const data = JSON.parse(jsonStr);

          if (data.token) {
            // æ„é€  Decap CMS éœ€è¦çš„ç”¨æˆ·å¯¹è±¡
            const userObj = {
              token: data.token,
              backendName: 'github' // å¿…é¡»ä¸ config.backend.name ä¸€è‡´
            };

            // ğŸ” å¼ºåˆ¶å†™å…¥ LocalStorage
            // Decap CMS å¯åŠ¨æ—¶ä¼šæ£€æŸ¥è¿™ä¸ª Keyï¼Œå¦‚æœæœ‰å€¼ï¼Œå°±è®¤ä¸ºå·²ç™»å½•
            const key = 'netlify-cms-user';
            localStorage.setItem(key, JSON.stringify(userObj));

            console.log('âœ… Token å·²å†™å…¥ LocalStorageï¼Œå‡†å¤‡åˆ·æ–°è¿›å…¥åå°...');

            // æ›´æ–° UI æç¤º
            const loadingEl = document.getElementById('js-loading');
            if (loadingEl) {
              loadingEl.innerHTML = `
                <div style="text-align:center">
                  <h3 style="color:#2ecc71; margin-bottom:10px;">è®¤è¯æˆåŠŸï¼</h3>
                  <p style="color:#666;">æ­£åœ¨è·³è½¬åˆ°åå°...</p>
                </div>
              `;
              loadingEl.style.display = 'flex';
            }

            // ğŸ”„ 1ç§’ååˆ·æ–°é¡µé¢ï¼Œè®© CMS è¯»å–åˆšåˆšå†™å…¥çš„ Token
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          }
        } catch (e) {
          console.error('âŒ å¼ºåˆ¶ç™»å½•å¤±è´¥:', e);
          alert('ç™»å½•è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚');
        }
      }
    });
  </script>

  <!-- âœ… 4. åŠ è½½ Decap CMS -->
  <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.9.0/dist/decap-cms.js" defer></script>

  <!-- âœ… 5. åˆå§‹åŒ–è„šæœ¬ -->
  <script is:inline>
    window.addEventListener('load', function () {
      const loadingEl = document.getElementById('js-loading');
      const configEl = document.getElementById('cms-config');

      if (!window.CMS) return;

      try {
        const CONFIG = JSON.parse(configEl.textContent);

        // åªæœ‰å½“ LocalStorage é‡Œæ²¡æœ‰ Token æ—¶ï¼ŒCMS æ‰ä¼šæ˜¾ç¤ºç™»å½•é¡µ
        // å¦åˆ™å®ƒä¼šç›´æ¥è¿›å…¥ Dashboard
        CMS.init({ config: CONFIG });

        // ç¨å¾®å»¶æ—¶éšè— loadingï¼Œé¿å…é—ªçƒ
        setTimeout(() => {
          // å¦‚æœå½“å‰æ˜¯ç™»å½•é¡µï¼ˆURLæ²¡æœ‰hashæˆ–hashæ˜¯ç™»å½•ç›¸å…³ï¼‰ï¼Œéšè—loadingæ˜¾ç¤ºç™»å½•æŒ‰é’®
          // å¦‚æœå·²ç™»å½•ï¼ŒCMS ä¼šè‡ªå·±æ¥ç®¡ç•Œé¢
          if (loadingEl) loadingEl.style.display = 'none';
        }, 500);

      } catch (e) {
        console.error('CMS Init Error:', e);
      }
    });
  </script>
</body>
</html>
