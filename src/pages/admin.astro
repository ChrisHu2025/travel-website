---
// src/pages/admin.astro
import { cmsConfig } from '../lib/cms/config';

export const prerender = true;

const serializedConfig = JSON.stringify({
  ...cmsConfig,
  load_config_file: false
});
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Explore China CMS - è¯Šæ–­æ¨¡å¼</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/decap-cms@3.9.0/dist/cms.css" />
  <style>
    body { margin: 0; background: #f0f2f5; font-family: monospace; }

    /* è¯Šæ–­é¢æ¿æ ·å¼ */
    #debug-panel {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.98); z-index: 20000;
      display: none; /* é»˜è®¤éšè—ï¼Œè§¦å‘æ—¶æ˜¾ç¤º */
      flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; box-sizing: border-box;
    }

    .log-box {
      width: 80%; max-width: 600px; height: 300px;
      background: #1e1e1e; color: #00ff00;
      padding: 15px; border-radius: 8px; overflow-y: auto;
      margin-bottom: 20px; border: 1px solid #333;
      white-space: pre-wrap; font-size: 13px;
    }

    .action-btn {
      padding: 15px 40px; font-size: 18px; font-weight: bold;
      color: white; background: #0070f3; border: none; border-radius: 5px;
      cursor: pointer; box-shadow: 0 4px 10px rgba(0,112,243,0.3);
      transition: transform 0.1s;
    }
    .action-btn:active { transform: scale(0.98); }

    h2 { color: #333; font-family: sans-serif; }
  </style>
</head>
<body>
  <div id="nc-root"></div>
  <script id="cms-config" type="application/json" is:inline set:html={serializedConfig}></script>

  <!-- è¯Šæ–­é¢æ¿ -->
  <div id="debug-panel">
    <h2>ğŸ” è®¤è¯è¯Šæ–­æ¨¡å¼</h2>
    <div class="log-box" id="screen-log">ç­‰å¾…è®¤è¯æ¶ˆæ¯...</div>
    <button class="action-btn" id="enter-btn" style="display:none" onclick="window.location.reload()">
      âœ… è¿›å…¥åå° (Reload)
    </button>
  </div>

  <script is:inline>
    // 1. è®¾ç½®æ ‡è®°
    window.CMS_MANUAL_INIT = true;

    // 2. å±å¹•æ—¥å¿—å‡½æ•°
    function logToScreen(msg) {
      const box = document.getElementById('screen-log');
      const time = new Date().toLocaleTimeString();
      box.innerHTML += `[${time}] ${msg}\n`;
      box.scrollTop = box.scrollHeight;
      console.log(msg); // åŒæ—¶ä¹Ÿæ‰“åˆ°æ§åˆ¶å°
    }

    // 3. ç›‘å¬æ¶ˆæ¯
    window.addEventListener('message', (event) => {
      if (typeof event.data === 'string' && event.data.startsWith('authorization:github:success:')) {

        // æ˜¾ç¤ºé¢æ¿
        document.getElementById('debug-panel').style.display = 'flex';
        logToScreen('ğŸ“¨ æ”¶åˆ° GitHub æ¶ˆæ¯ï¼');

        try {
          const jsonStr = event.data.match(/success:(.+)/)[1];
          const data = JSON.parse(jsonStr);

          if (data.token) {
            logToScreen(`ğŸ”‘ Token æ•è·æˆåŠŸ (é•¿åº¦: ${data.token.length})`);

            // --- å…³é”®æ“ä½œ A: å†™å…¥ LocalStorage ---
            // è¿™æ˜¯æœ€æ ¸å¿ƒçš„ç™»å½•å‡­è¯
            const userObj = {
              token: data.token,
              backendName: 'github' // å¿…é¡»åŒ¹é… config ä¸­çš„ backend.name
            };
            localStorage.setItem('netlify-cms-user', JSON.stringify(userObj));
            logToScreen(`ğŸ’¾ å·²å†™å…¥ LocalStorage: netlify-cms-user`);
            logToScreen(`ğŸ“„ å†…å®¹é¢„è§ˆ: ${JSON.stringify(userObj).substring(0, 40)}...`);

            // --- å…³é”®æ“ä½œ B: æ³¨å…¥ URL Hash ---
            // ä½œä¸ºåŒé‡ä¿é™©
            const newHash = `#token=${data.token}`;
            window.location.hash = newHash;
            logToScreen(`ğŸ”— å·²æ³¨å…¥ URL Hash: #token=...`);

            // --- å…³é”®æ“ä½œ C: æ˜¾ç¤ºæŒ‰é’® ---
            logToScreen('âœ… å‡†å¤‡å°±ç»ªï¼è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›å…¥åå°ã€‚');
            document.getElementById('enter-btn').style.display = 'block';

          } else {
            logToScreen('âŒ é”™è¯¯: æ•°æ®ä¸­æ²¡æœ‰ Token');
          }
        } catch (e) {
          logToScreen(`âŒ å¼‚å¸¸: ${e.message}`);
        }
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.9.0/dist/decap-cms.js"></script>

  <script is:inline>
    // 4. åˆå§‹åŒ– CMS
    window.addEventListener('load', function() {
      const configEl = document.getElementById('cms-config');
      if (!window.CMS) return;

      try {
        const config = JSON.parse(configEl.textContent);

        // åŠ¨æ€è®¾ç½® base_url
        config.backend.base_url = window.location.origin;
        config.backend.auth_endpoint = '/api/decap-cms-github';

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çŠ¶æ€
        const existingUser = localStorage.getItem('netlify-cms-user');
        if (existingUser) {
           console.log('æ£€æµ‹åˆ°ç°æœ‰ç™»å½•ä¼šè¯');
        }

        CMS.init({ config });

      } catch (e) {
        console.error('Init Error:', e);
      }
    });
  </script>
</body>
</html>
