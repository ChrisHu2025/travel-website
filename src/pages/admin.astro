---
// src/pages/admin.astro
import { cmsConfig } from '../lib/cms/config';

export const prerender = true;

// åºåˆ—åŒ–é…ç½®ä¸ºå†…è” JSON
const serializedConfig = JSON.stringify({
  ...cmsConfig,
  load_config_file: false
});
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å†…å®¹ç®¡ç†ç³»ç»Ÿ - Explore China</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/decap-cms@3.9.0/dist/cms.css" />
  <style>
    /* ç®€å•çš„ UI æ ·å¼ */
    body { margin: 0; background: #f5f5f5; }
    .cms-loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: white; z-index: 9999;
    }
    .loading-text { margin-top: 15px; color: #666; font-family: sans-serif; }
    .debug-console {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 150px;
      background: #222; color: #0f0; font-family: monospace; font-size: 12px;
      padding: 10px; overflow-y: auto; z-index: 10000; display: none; /* é»˜è®¤éšè—ï¼Œéœ€è¦æ—¶å¯å¼€å¯ */
    }
  </style>
</head>
<body>
  <div id="nc-root" is:inline></div>

  <!-- âœ… 1. æ³¨å…¥é…ç½® (type="application/json") -->
  <script id="cms-config" type="application/json" is:inline set:html={serializedConfig}></script>

  <!-- âœ… 2. Loading ç•Œé¢ -->
  <div class="cms-loading" id="js-loading">
    <div class="loading-spinner">Loading...</div>
    <div class="loading-text">æ­£åœ¨åˆå§‹åŒ– CMS... (æŒ‰ F12 æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—)</div>
  </div>

  <!-- âœ… 3. æ ¸å¿ƒè°ƒè¯•è„šæœ¬ (Debug Listener) -->
  <script is:inline>
    // å¼€å¯æ‰‹åŠ¨åˆå§‹åŒ–
    window.CMS_MANUAL_INIT = true;

    // === ğŸ•µï¸â€â™‚ï¸ ä¾¦æ¢è„šæœ¬ï¼šç›‘å¬æ‰€æœ‰è·¨çª—å£æ¶ˆæ¯ ===
    window.addEventListener('message', (event) => {
      console.log('ğŸ“¨ [Adminæ”¶åˆ°æ¶ˆæ¯]', event);

      // æ£€æŸ¥æ˜¯å¦æ˜¯æˆ‘ä»¬æœŸæœ›çš„ GitHub è®¤è¯æ¶ˆæ¯
      if (typeof event.data === 'string' && event.data.startsWith('authorization:github:success:')) {
        console.log('âœ… [Admin] æ•è·åˆ° GitHub æˆåŠŸè®¤è¯ Tokenï¼');
        console.log('ğŸ“¦ æ•°æ®å†…å®¹:', event.data);
        const jsonStr = event.data.match(/success:(.+)/)[1];
        try {
          const data = JSON.parse(jsonStr);
          console.log('ğŸ”‘ è§£æå‡ºçš„ Token:', data.token);
          alert('ç³»ç»Ÿå·²æ”¶åˆ° GitHub æˆæƒï¼å¦‚æœé¡µé¢æœªè·³è½¬ï¼Œè¯·æ£€æŸ¥ Decap CMS é…ç½®ã€‚Tokenå·²è·å–ã€‚');
        } catch (e) {
          console.error('âŒ è§£æ Token å¤±è´¥:', e);
        }
      }
    });

    console.log('ğŸ“¡ [Admin] æ¶ˆæ¯ç›‘å¬å™¨å·²å°±ç»ªï¼Œç­‰å¾…å¼¹çª—å‘é€ Token...');
  </script>

  <!-- âœ… 4. åŠ è½½ Decap CMS -->
  <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.9.0/dist/decap-cms.js" defer></script>

  <!-- âœ… 5. åˆå§‹åŒ–è„šæœ¬ -->
  <script is:inline>
    window.addEventListener('load', function () {
      const loadingEl = document.getElementById('js-loading');
      const configEl = document.getElementById('cms-config');

      if (!window.CMS) {
        alert('Decap CMS åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼');
        return;
      }

      try {
        const CONFIG = JSON.parse(configEl.textContent);
        console.log('ğŸš€ [Admin] å¼€å§‹åˆå§‹åŒ– CMS, use_state:', CONFIG.backend.use_state);

        CMS.init({ config: CONFIG });

        setTimeout(() => {
          if (loadingEl) loadingEl.style.display = 'none';
        }, 500);
      } catch (e) {
        console.error('CMS Init Error:', e);
        alert('CMS åˆå§‹åŒ–é”™è¯¯: ' + e.message);
      }
    });
  </script>
</body>
</html>
