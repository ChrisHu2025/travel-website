---
// src/pages/admin.astro
import { cmsConfig } from '../lib/cms/config';

export const prerender = true;

const serializedConfig = JSON.stringify({
  ...cmsConfig,
  load_config_file: false
});
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Content Manager</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/decap-cms@3.9.0/dist/cms.css" />
  <style>
    /* è¦†ç›–å±‚ï¼šæœªç™»å½•æ—¶æ˜¾ç¤º */
    #auth-overlay {
      position: fixed; inset: 0; z-index: 10000;
      background: #f4f6f8;
      display: none; /* JS æ§åˆ¶æ˜¾ç¤º */
      flex-direction: column; align-items: center; justify-content: center;
    }
    .auth-box {
      background: white; padding: 40px; border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center;
      width: 320px;
    }
    .btn {
      background: #24292e; color: white; border: none; padding: 12px;
      width: 100%; border-radius: 6px; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: 0.2s; margin-top: 20px;
    }
    .btn:hover { background: #000; }
    .status { margin-top: 15px; font-size: 13px; color: #666; min-height: 20px;}
  </style>
</head>
<body>
  <div id="nc-root"></div>
  <script id="cms-config" type="application/json" is:inline set:html={serializedConfig}></script>

  <!-- è‡ªå®šä¹‰ç™»å½•ç•Œé¢ -->
  <div id="auth-overlay">
    <div class="auth-box">
      <h2>Explore China Admin</h2>
      <p style="color:#666">è¯·ç™»å½•ä»¥ç®¡ç†ç½‘ç«™å†…å®¹</p>

      <button id="login-btn" class="btn">Login with GitHub</button>
      <div id="status-msg" class="status"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.9.0/dist/decap-cms.js"></script>

  <script is:inline>
    // 1. æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    const USER_KEY = 'netlify-cms-user';
    const existingUser = localStorage.getItem(USER_KEY);

    if (!existingUser) {
      // ğŸ›‘ æœªç™»å½•ï¼šæ˜¾ç¤ºè¦†ç›–å±‚
      const overlay = document.getElementById('auth-overlay');
      const btn = document.getElementById('login-btn');
      const status = document.getElementById('status-msg');

      overlay.style.display = 'flex';

      // ç‚¹å‡»ç™»å½•
      btn.addEventListener('click', () => {
        status.innerText = 'æ­£åœ¨æ‰“å¼€ GitHub...';
        const w = 600, h = 600;
        const left = (window.innerWidth - w) / 2;
        const top = (window.innerHeight - h) / 2;

        // æ‰“å¼€æˆ‘ä»¬çš„ API
        window.open('/api/decap-cms-github', 'GitHubAuth', `width=${w},height=${h},top=${top},left=${left}`);
      });

      // ç›‘å¬æ¶ˆæ¯
      window.addEventListener('message', (e) => {
        if (typeof e.data === 'string' && e.data.startsWith('authorization:github:success:')) {
          status.innerText = 'è®¤è¯æˆåŠŸï¼æ­£åœ¨å†™å…¥å‡­è¯...';
          status.style.color = 'green';

          try {
            const data = JSON.parse(e.data.match(/success:(.+)/)[1]);

            // âœ… å†™å…¥ Token
            localStorage.setItem(USER_KEY, JSON.stringify({
              token: data.token,
              backendName: 'github'
            }));

            status.innerText = 'ç™»å½•å®Œæˆï¼å³å°†åˆ·æ–°...';

            // ğŸ”„ åˆ·æ–°é¡µé¢è¿›å…¥åå°
            setTimeout(() => window.location.reload(), 1000);

          } catch (err) {
            console.error(err);
            status.innerText = 'Token è§£æå¤±è´¥';
            status.style.color = 'red';
          }
        }
      });
    }

    // 2. åˆå§‹åŒ– CMS (æ— è®ºæ˜¯å¦ç™»å½•éƒ½è¿è¡Œ)
    window.addEventListener('load', () => {
      const configEl = document.getElementById('cms-config');
      if (window.CMS && configEl) {
        const config = JSON.parse(configEl.textContent);
        // ä¿æŒçº¯å‡€é…ç½®ï¼Œè®© CMS ç›´è¿ GitHub
        CMS.init({ config });
      }
    });
  </script>
</body>
</html>
