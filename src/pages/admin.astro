---
// src/pages/admin.astro
import { Fragment } from 'astro/jsx-runtime';
import '../styles/global.css';
export const prerender = true;

// ğŸ¯ 1. æ„å»ºæ—¶å‡†å¤‡é…ç½®
const cmsConfig = {
  backend: {
    name: 'github',
    repo: 'ChrisHu2025/travel-website',
    branch: 'main',
    auth_scope: 'public_repo',
    auth_type: 'implicit',
    client_id: 'Ov23liJds0MQcgZsIeob',
    base_url: 'https://explorechina.travel'
  },
  site_url: 'https://explorechina.travel',
  display_url: 'https://explorechina.travel',
  media_folder: 'public/images/uploads',
  public_folder: '/images/uploads',
  load_config_file: false,
  collections: [
    {
      name: 'destinations',
      label: 'æ¨èç›®çš„åœ°',
      label_singular: 'ç›®çš„åœ°',
      folder: 'src/content/destinations',
      create: true,
      slug: '{{slug}}',
      fields: [
        { label: 'æ ‡é¢˜', name: 'title', widget: 'string' },
        { label: 'æè¿°', name: 'description', widget: 'text' },
        { label: 'æ­£æ–‡', name: 'body', widget: 'markdown' }
      ]
    }
  ]
};

// ğŸ¯ 2. åŒé‡å®‰å…¨è½¬ä¹‰ç­–ç•¥
// ç¬¬ä¸€æ­¥ï¼šæ ‡å‡†JSONåºåˆ—åŒ– + XSSé˜²æŠ¤
let configString = JSON.stringify(cmsConfig)
  .replace(/</g, '\\u003c')    // XSSé˜²æŠ¤ï¼šé˜²æ­¢HTMLæ³¨å…¥
  .replace(/>/g, '\\u003e');   // XSSé˜²æŠ¤ï¼šé˜²æ­¢HTMLæ³¨å…¥

// ç¬¬äºŒæ­¥ï¼šé’ˆå¯¹æ¨¡æ¿å­—ç¬¦ä¸²çš„å®‰å…¨è½¬ä¹‰ï¼ˆåŒäº‹å»ºè®®ï¼‰
const safeConfigString = configString
  .replace(/\\/g, '\\\\')  // è½¬ä¹‰åæ–œæ 
  .replace(/`/g, '\\`')    // è½¬ä¹‰åå¼•å·
  .replace(/\$/g, '\\$');  // è½¬ä¹‰ç¾å…ƒç¬¦å·

// ğŸ¯ 3. ç”Ÿæˆå®Œæ•´HTMLï¼ˆåŒ…å«æ”¹è¿›çš„ç”¨æˆ·ä½“éªŒï¼‰
const fullHtml = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†…å®¹ç®¡ç†ç³»ç»Ÿ - Explore China</title>
  <link rel="stylesheet" href="https://unpkg.com/decap-cms@^3.0.0/dist/cms.css">
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
    }
    #nc-root {
      min-height: 100vh;
    }
    .cms-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: white;
      z-index: 9999;
      transition: opacity 0.3s;
    }
    .cms-loading.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    .loading-text {
      color: #666;
      font-size: 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .cms-error {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ffebee;
      color: #c62828;
      padding: 12px 24px;
      border-radius: 4px;
      border-left: 4px solid #c62828;
      max-width: 90%;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <!-- CMSæ ¹å®¹å™¨ -->
  <div id="nc-root"></div>

  <!-- åŠ è½½çŠ¶æ€ -->
  <div class="cms-loading" id="js-loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">æ­£åœ¨åŠ è½½å†…å®¹ç¼–è¾‘å™¨...</div>
  </div>

  <!-- é”™è¯¯æç¤ºå®¹å™¨ï¼ˆåˆå§‹éšè—ï¼‰ -->
  <div class="cms-error" id="js-error" style="display: none;"></div>

  <!-- Decap CMSè„šæœ¬ -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <script>
    // å¯ç”¨æ‰‹åŠ¨åˆå§‹åŒ–æ¨¡å¼
    window.CMS_MANUAL_INIT = true;

    // âœ… å®‰å…¨åœ°è§£æé…ç½®ï¼ˆä½¿ç”¨å­—ç¬¦ä¸²è¿æ¥é¿å…Astroæ„å»ºæ—¶è§£æï¼‰
    const CONFIG = JSON.parse('' + safeConfigString + '');

    // é”™è¯¯å¤„ç†å™¨
    const errorHandler = {
      showError: function(message) {
        const errorEl = document.getElementById('js-error');
        if (errorEl) {
          errorEl.textContent = 'é”™è¯¯: ' + message;
          errorEl.style.display = 'block';
        }
        console.error('CMSåˆå§‹åŒ–é”™è¯¯:', message);
      },

      hideError: function() {
        const errorEl = document.getElementById('js-error');
        if (errorEl) {
          errorEl.style.display = 'none';
        }
      }
    };

    // CMSåˆå§‹åŒ–é€»è¾‘
    document.addEventListener('DOMContentLoaded', function() {
      let initAttempts = 0;
      const maxAttempts = 30; // 30æ¬¡å°è¯• * 100ms = 3ç§’è¶…æ—¶

      function initCMS() {
        initAttempts++;

        // æ£€æŸ¥CMSåº“æ˜¯å¦åŠ è½½å®Œæˆ
        if (!window.CMS) {
          if (initAttempts >= maxAttempts) {
            errorHandler.showError('æ— æ³•åŠ è½½CMSåº“ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥');
            return;
          }
          setTimeout(initCMS, 100);
          return;
        }

        try {
          // éšè—é”™è¯¯æç¤º
          errorHandler.hideError();

          // åˆå§‹åŒ–CMS
          console.log('æ­£åœ¨åˆå§‹åŒ–CMSï¼Œä½¿ç”¨é…ç½®:', CONFIG.backend);
          CMS.init({ config: CONFIG });

          // æ³¨å†Œåˆå§‹åŒ–å®Œæˆäº‹ä»¶
          CMS.registerEventListener({
            name: 'init',
            handler: function() {
              // éšè—åŠ è½½çŠ¶æ€
              const loadingEl = document.getElementById('js-loading');
              if (loadingEl) {
                loadingEl.classList.add('hidden');
                // 3ç§’åå®Œå…¨ç§»é™¤ï¼Œé¿å…å¹²æ‰°
                setTimeout(() => {
                  loadingEl.style.display = 'none';
                }, 300);
              }
              console.log('âœ… CMS UIå·²å°±ç»ª');
            }
          });

          // æ³¨å†Œé”™è¯¯äº‹ä»¶
          CMS.registerEventListener({
            name: 'error',
            handler: function(error) {
              errorHandler.showError(error.message || 'æœªçŸ¥é”™è¯¯');
            }
          });

        } catch (error) {
          errorHandler.showError(error.message || 'åˆå§‹åŒ–å¤±è´¥');
        }
      }

      // å¼€å§‹åˆå§‹åŒ–
      initCMS();
    });

    // å…¨å±€é”™è¯¯æ•è·
    window.addEventListener('error', function(event) {
      errorHandler.showError(event.message || 'é¡µé¢è„šæœ¬é”™è¯¯');
    });
  </script>
</body>
</html>
`;
---

<!-- 4. ä½¿ç”¨ set:html æŒ‡ä»¤ç›´æ¥è¾“å‡ºå®Œæ•´HTML -->
<Fragment set:html={fullHtml} />
