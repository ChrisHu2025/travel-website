---
import Layout from '@layouts/Layout.astro';
import { getCollection, getEntry } from 'astro:content';
import { cleanEntryId } from '../../utils/cleanEntryId';

// 为不同层级结构生成正确的路径
export async function getStaticPaths() {
  try {
    const destinations = await getCollection('destinations');
    const stories = await getCollection('stories');
    const inSeason = await getCollection('in-season');
    const resorts = await getCollection('resorts');
    
    const paths = [];
    
    // destinations: 4级结构 - /destinations/city/spot/
    destinations.forEach(entry => {
      const cleanId = cleanEntryId(entry.id);
      const parts = cleanId.split('/');
      
      if (parts.length >= 2) {
        const city = parts[0];
        const spot = parts.slice(1).join('/');
        paths.push({
          params: { 
            category: 'destinations', 
            slug: `${city}/${spot}`
          }
        });
      }
    });
    
    // stories: 4级结构 - /stories/city/story/
    stories.forEach(entry => {
      const cleanId = cleanEntryId(entry.id);
      const parts = cleanId.split('/');
      
      if (parts.length >= 2) {
        const city = parts[0];
        const story = parts.slice(1).join('/');
        paths.push({
          params: { 
            category: 'stories', 
            slug: `${city}/${story}`
          }
        });
      }
    });
    
    // in-season: 3级结构 - /in-season/spot/
    inSeason.forEach(entry => {
      const spot = cleanEntryId(entry.id);
      paths.push({
        params: { 
          category: 'in-season', 
          slug: spot
        }
      });
    });
    
    // resorts: 3级结构 - /resorts/resort/
    resorts.forEach(entry => {
      const resort = cleanEntryId(entry.id);
      paths.push({
        params: { 
          category: 'resorts', 
          slug: resort
        }
      });
    });
    
    return paths;
  } catch (error) {
    console.error('Error generating static paths:', error);
    return [];
  }
}

// 获取当前页面参数
const { category, slug } = Astro.params;

// 根据分类获取对应集合
const collectionName = 
  category === 'in-season' ? 'in-season' :
  category === 'destinations' ? 'destinations' :
  category === 'stories' ? 'stories' :
  category === 'resorts' ? 'resorts' : null;

// 获取内容 - 处理不同结构
let entry = null;
if (collectionName) {
  try {
    // 清理slug参数
    const cleanSlug = cleanEntryId(slug);
    
    // 重建集合ID
    let id = cleanSlug;
    
    // 对于多级路径，需要匹配集合中的ID格式
    if (category === 'destinations' || category === 'stories') {
      // 在 Astro v4 中，ID 格式不同
      id = `${category}/${cleanSlug}`;
    }
    
    entry = await getEntry(collectionName, id);
  } catch (error) {
    console.error(`Error loading ${category}/${slug}:`, error);
  }
}

// 404处理
if (!entry) {
  return Astro.redirect('/404');
}

// 页面标题
const pageTitle = entry.data.title ? `${entry.data.title} - Explore China` : 'Content Not Found - Explore China';
---

<Layout title={pageTitle}>
  <div class="min-h-screen bg-gray-50">
    <!-- 三级页面大图区域 -->
    <section class="relative h-[60vh] md:h-[70vh]">
      <div class="absolute inset-0">
        <img 
          src={entry.data.image || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2000&q=80'} 
          alt={entry.data.title} 
          class="w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div>
      </div>
      <div class="container mx-auto px-4 h-full flex flex-col justify-end">
        <div class="max-w-4xl pb-12 md:pb-20">
          <div class="flex flex-wrap items-center text-white text-sm mb-4">
            <span class="mr-2">{entry.data.date ? new Date(entry.data.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
            <span class="mx-2">•</span>
            <span>{entry.data.author || 'Explore China Team'}</span>
            <span class="mx-2">•</span>
            <span>{Math.round((entry.data.body || '').split(' ').length / 250)} min read</span>
          </div>
          <h1 class="text-3xl md:text-5xl font-serif font-bold text-white max-w-3xl leading-tight">
            {entry.data.title}
          </h1>
          {entry.data.subtitle && (
            <p class="text-xl text-gray-200 mt-4 max-w-3xl">{entry.data.subtitle}</p>
          )}
          <div class="mt-6 flex flex-wrap gap-2">
            {(entry.data.tags || []).map((tag, index) => (
              <span 
                key={index} 
                class="px-3 py-1 bg-white/20 backdrop-blur-sm text-white rounded-full text-sm"
              >
                {tag}
              </span>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- 正文内容区域 -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto prose prose-lg">
          <!-- 内容顶部信息 -->
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-12">
            <div>
              <h2 class="text-2xl font-serif font-bold text-gray-900 mb-3">
                {entry.data.introduction_title || 'Journey Overview'}
              </h2>
              <p class="text-gray-700 text-lg">{entry.data.introduction || 'Discover the authentic travel experiences and cultural insights of this remarkable destination.'}</p>
            </div>
            <div class="mt-6 md:mt-0 flex space-x-4">
              <button class="text-gray-600 hover:text-indigo-600 transition-colors">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg>
              </button>
              <button class="text-gray-600 hover:text-indigo-600 transition-colors">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z" />
                </svg>
              </button>
            </div>
          </div>

          <!-- 主要内容 -->
          <div class="space-y-12">
            {entry.data.body ? entry.data.body.split('### ').slice(1).map((section, index) => {
              const [title, ...content] = section.split('\n');
              return (
                <div class="mb-12" key={index}>
                  <h2 class="text-2xl font-serif font-bold text-gray-900 mb-6">{title || 'Section Title'}</h2>
                  <div 
                    class="prose prose-lg max-w-none text-gray-700"
                    set:html={content.join('\n').replace(/!\[.*?\]\((.*?)\)/g, '<img src="$1" alt="Travel image" class="w-full rounded-xl shadow-md my-8">') || '<p>Content not available.</p>'}
                  />
                </div>
              );
            }) : (
              <div class="text-gray-700">
                <p>{entry.data.body || 'Content is temporarily unavailable. Please check back later.'}</p>
              </div>
            )}
          </div>

          <!-- 实用信息卡片 -->
          <div class="mt-16 bg-indigo-50 rounded-2xl p-8 border border-indigo-100">
            <h3 class="text-xl font-serif font-bold text-indigo-900 mb-6">Travel Essentials</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h4 class="font-bold text-gray-800 mb-2">Best Time to Visit</h4>
                <p class="text-gray-600">{entry.data.best_time || 'Spring (April-May) and Autumn (September-October) offer the most pleasant temperatures and clear skies.'}</p>
              </div>
              <div>
                <h4 class="font-bold text-gray-800 mb-2">Getting There</h4>
                <p class="text-gray-600">{entry.data.getting_there || 'The nearest international airport is 2 hours away, with regular shuttle services available to the site.'}</p>
              </div>
              <div>
                <h4 class="font-bold text-gray-800 mb-2">Local Tips</h4>
                <p class="text-gray-600">{entry.data.local_tips || 'Bargaining is expected at local markets. Carrying small bills makes transactions easier. Always carry bottled water.'}</p>
              </div>
              <div>
                <h4 class="font-bold text-gray-800 mb-2">Cultural Notes</h4>
                <p class="text-gray-600">{entry.data.cultural_notes || 'Dress modestly when visiting religious sites. Always ask permission before photographing local people.'}</p>
              </div>
            </div>
          </div>

          <!-- 作者信息 -->
          <div class="mt-16 flex items-start space-x-6 pt-8 border-t border-gray-200">
            <img 
              src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=200&q=80" 
              alt="Author" 
              class="w-16 h-16 rounded-full object-cover"
            />
            <div>
              <h4 class="font-serif font-bold text-gray-900">{entry.data.author || 'Explore China Team'}</h4>
              <p class="text-gray-600 mt-1">{entry.data.author_bio || 'Passionate traveler and cultural enthusiast exploring the hidden gems of China since 2015.'}</p>
              <a href="/about" class="mt-2 inline-block text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                More from this author →
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 相关内容推荐 -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-serif font-bold text-center mb-12">You May Also Like</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {[1, 2, 3].map((item, index) => (
            <article class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow group" key={index}>
              <div class="h-48 overflow-hidden">
                <img 
                  src={`https://images.unsplash.com/photo-${1506744038136 + index * 1000}?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=800&q=80`} 
                  alt="Related content" 
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                />
              </div>
              <div class="p-6">
                <span class="inline-block px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm mb-3">
                  Related
                </span>
                <h3 class="text-lg font-serif font-bold text-gray-900 mb-2">Another Beautiful Destination in China</h3>
                <p class="text-gray-600 mb-4">Discover the hidden charm of this lesser-known location with authentic local experiences.</p>
                <a href="#" class="text-indigo-600 hover:text-indigo-800 font-medium flex items-center group/btn">
                  Read more
                  <svg class="ml-2 w-4 h-4 opacity-0 group-hover/btn:opacity-100 transform group-hover/btn:translate-x-1 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>

    <!-- Newsletter section - 延续首页设计 -->
    <section class="py-16 bg-gradient-to-r from-indigo-600 to-purple-700 text-white">
      <div class="container mx-auto px-4 text-center">
        <div class="max-w-3xl mx-auto">
          <h2 class="text-3xl font-serif font-bold mb-4">Continue Your Journey</h2>
          <p class="text-xl opacity-90 mb-8">
            Never miss a travel story. Subscribe for more authentic experiences and insider tips.
          </p>
          <form class="max-w-md mx-auto flex flex-col sm:flex-row gap-4">
            <input 
              type="email" 
              placeholder="Enter your email address" 
              class="flex-1 px-6 py-4 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-400"
              required
            />
            <button 
              type="submit" 
              class="bg-white text-indigo-600 font-medium px-8 py-4 rounded-lg hover:bg-gray-100 transition-colors shadow-lg"
            >
              Join the Community
            </button>
          </form>
        </div>
      </div>
    </section>
  </div>
</Layout>