---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allDestinations = await getCollection('destinations');
  const cities = [...new Set(allDestinations.map(d => d.data.city.toLowerCase()))];

  return cities.map(city => {
    // 忽略大小写筛选
    const filtered = allDestinations.filter(d => d.data.city.toLowerCase() === city);
    // 获取城市元数据 (取第一篇文章的 region)
    const cityMeta = filtered[0]?.data;

    return {
      params: { city },
      props: {
        cityDisplayName: cityMeta ? cityMeta.city : city,
        region: cityMeta ? cityMeta.region : '',
        posts: filtered
      },
    };
  });
}

const { cityDisplayName, region, posts } = Astro.props;
---

<Layout title={`${cityDisplayName} City Guide - Explore China`}>
  <div class="min-h-screen bg-white">

    <!-- 1. Pure Text Hero (Magazine Style) -->
    <!-- 极简、留白、大字号 -->
    <header class="pt-32 pb-16 md:pt-48 md:pb-32 container mx-auto px-4 max-w-7xl">
      <div class="max-w-4xl">
        <span class="text-xs font-bold tracking-[0.2em] text-gray-400 uppercase mb-6 block">
          Destination Guide / {region}
        </span>
        <h1 class="text-7xl md:text-9xl font-serif font-bold text-gray-900 tracking-tighter leading-none mb-10">
          {cityDisplayName}
        </h1>
        <div class="w-24 h-1 bg-black mb-10"></div>
        <p class="text-xl md:text-2xl text-gray-600 font-serif italic max-w-2xl leading-relaxed">
          A curated selection of the most authentic experiences, hidden gems, and architectural marvels in {cityDisplayName}.
        </p>
      </div>
    </header>

    <!-- 装饰线 -->
    <div class="border-t border-gray-100 mb-20 md:mb-32"></div>

    <!-- 2. Attraction List (Z-Pattern Layout) -->
    <main class="container mx-auto px-4 max-w-7xl pb-32">
      <div class="flex flex-col gap-32">
        {posts.map((item, index) => {
          // Z-Pattern Logic: 偶数项 (index 1, 3...) 反转布局
          const isReversed = index % 2 !== 0;
          // 获取图片列表：优先使用 gallery，没有则回退到 image (封装成数组)
          const images = item.data.gallery && item.data.gallery.length > 0
            ? item.data.gallery
            : [item.data.image];

          return (
            <article class={`flex flex-col md:flex-row gap-8 md:gap-16 items-start ${isReversed ? 'md:flex-row-reverse' : ''}`}>

              <!-- Image Carousel (60% Width) -->
              <div class="w-full md:w-[60%] relative group">
                <!-- CSS Scroll Snap Container -->
                <div class="flex overflow-x-auto snap-x snap-mandatory aspect-[4/3] md:aspect-[3/2] no-scrollbar rounded-sm bg-gray-100">
                  {images.map((img, i) => (
                    <img
                      src={img}
                      alt={`${item.data.title} - Image ${i+1}`}
                      class="snap-center shrink-0 w-full h-full object-cover"
                    />
                  ))}
                </div>
                <!-- Page Indicator (Optional) -->
                {images.length > 1 && (
                  <div class="absolute bottom-4 right-4 bg-black/50 backdrop-blur px-3 py-1 text-white text-xs font-bold rounded-full">
                    1 / {images.length}
                  </div>
                )}
              </div>

              <!-- Text Content (40% Width) -->
              <div class="w-full md:w-[40%] flex flex-col justify-center pt-4 md:pt-8">

                <!-- Serial Number -->
                <div class="flex items-center gap-4 mb-6">
                  <div class="h-px w-8 bg-gray-300"></div>
                  <span class="font-mono text-gray-400 font-bold text-lg">
                    {String(index + 1).padStart(2, '0')}
                  </span>
                  <div class="h-px w-8 bg-gray-300"></div>
                </div>

                <!-- Title -->
                <h2 class="text-3xl md:text-4xl font-serif font-bold text-gray-900 mb-6 leading-tight">
                  {item.data.title}
                </h2>

                <!-- Best Season -->
                <div class="mb-8">
                  <span class="text-xs font-bold tracking-widest uppercase text-gray-400 block mb-2">Best Time</span>
                  <span class="text-sm font-medium text-indigo-900 bg-indigo-50 px-3 py-1 rounded-sm">
                    {item.data.best_season.join(', ')}
                  </span>
                </div>

                <!-- Highlights (Bullet Points) -->
                {item.data.highlights && item.data.highlights.length > 0 ? (
                  <ul class="space-y-4 mb-8">
                    {item.data.highlights.map(point => (
                      <li class="flex items-start text-gray-600 text-sm leading-relaxed">
                        <span class="mr-3 text-indigo-600 font-bold text-lg leading-none">•</span>
                        {point}
                      </li>
                    ))}
                  </ul>
                ) : (
                  // Fallback: 如果没有highlights，显示 summary
                  <p class="text-gray-600 text-sm leading-relaxed mb-8 border-l-2 border-gray-200 pl-4 italic">
                    {item.data.card_summary}
                  </p>
                )}

                <!-- Future Link (Initially Hidden) -->
                <!--
                  TODO: Remove 'hidden' class when L3 pages are ready.
                  Currently pointing to path but visually hidden.
                -->
                <a
                  href={`/destinations/${item.data.path}/`}
                  class="hidden inline-flex items-center text-xs font-bold uppercase tracking-widest text-black border-b-2 border-black pb-1 hover:text-indigo-600 hover:border-indigo-600 transition-colors w-fit"
                >
                  Read Full Guide ->
                </a>

              </div>
            </article>
          );
        })}
      </div>
    </main>

    <!-- Bottom Navigation -->
    <div class="container mx-auto px-4 max-w-7xl pb-20 border-t border-gray-100 pt-10 text-center">
      <a href="/destinations" class="text-gray-400 hover:text-black transition-colors font-serif italic text-lg">
        ← Back to All Destinations
      </a>
    </div>

  </div>
</Layout>

<style>
  /* Utility to hide scrollbar but keep functionality */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }
</style>
